
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="ISKCON Hadapsar Japa Sadhana App">
    <title>ISKCON Hadapsar | Japa Sadhana</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons & Fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { saffron: '#FF9933', deep: '#050505', glass: 'rgba(255,255,255,0.08)' },
                    fontFamily: { sans: ['Outfit', 'sans-serif'], serif: ['Cinzel', 'serif'] },
                    animation: { 'fade-in': 'fadeIn 0.3s ease-out' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'scale(0.98)' }, '100%': { opacity: '1', transform: 'scale(1)' } } }
                }
            }
        }
    </script>

    <style>
        body { background-color: #000; color: white; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }
        * { user-select: none; -webkit-user-select: none; outline: none; }
        
        /* Background Art */
        .bg-fixed-art {
            position: fixed; inset: 0; z-index: -1;
            background-image: url('https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEj2zqiTZ78j6B7tqYFh5Cd-agJGzRJLOLARjfgZWNDzH9YjzEJ53lN8uveWFnvniWz58inZsgDc0aZdk5Feaddu14G9hoHnEOmUPb1_3ZdkT8ShL2PWpUe_sgf-EiNU4nWqD7X9ayVkkxa_Rpw5HpmP2qXLrAb74siFSirEj_a5C8Qk1oZGTq1yrgJqQ60/s1280/maxresdefault%20(2).jpg');
            background-size: cover; background-position: center; opacity: 0.15;
        }

        .tap-active { transform: scale(0.96); border-color: #FF9933 !important; box-shadow: 0 0 40px rgba(255, 153, 51, 0.5); }
        .ring-progress { transition: stroke-dashoffset 0.1s linear; transform: rotate(-90deg); transform-origin: 50% 50%; }
        
        /* Accordion Styles */
        .history-details { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .history-card.active .history-details { max-height: 500px; }
        .history-card.active .chevron { transform: rotate(180deg); color: #FF9933; }
        .chevron { transition: transform 0.3s; }

        .hide-scroll::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden text-gray-100">
    
    <div class="bg-fixed-art"></div>

    <!-- HEADER -->
    <header class="flex justify-between items-center px-5 py-4 bg-black/60 backdrop-blur-md border-b border-white/10 z-20">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full border border-saffron/50 p-0.5 shadow-lg shadow-saffron/10">
                <img src="https://cdn-icons-png.flaticon.com/512/3663/3663335.png" class="w-full h-full rounded-full object-cover">
            </div>
            <div>
                <h1 class="font-serif text-saffron font-bold text-sm tracking-widest">ISKCON HADAPSAR</h1>
                <div class="flex items-center gap-1.5 text-[10px] text-gray-400 font-medium">
                    <i class="fas fa-fire text-orange-500"></i>
                    <span id="streakDisplay">0 Day Streak</span>
                </div>
            </div>
        </div>
        <div class="flex gap-4">
            <button onclick="openHistory()" class="text-gray-300 hover:text-saffron transition transform active:scale-90"><i class="fas fa-history text-xl"></i></button>
            <button onclick="openSettings()" class="text-gray-300 hover:text-saffron transition transform active:scale-90"><i class="fas fa-cog text-xl"></i></button>
        </div>
    </header>

    <!-- MAIN DASHBOARD -->
    <main class="flex-1 flex flex-col items-center justify-center relative w-full max-w-lg mx-auto p-4 z-10">
        
        <!-- Stats Row -->
        <div class="grid grid-cols-2 gap-3 w-full mb-6">
            <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl p-4 flex flex-col items-center shadow-lg">
                <span class="text-[9px] text-gray-400 uppercase tracking-widest font-bold">Rounds Today</span>
                <div class="flex items-baseline gap-1 mt-1">
                    <span id="roundsDisplay" class="text-3xl font-bold text-white">0</span>
                    <span id="targetDisplay" class="text-sm font-bold text-saffron opacity-80">/ 16</span>
                </div>
            </div>
            <div class="bg-white/5 backdrop-blur-md border border-white/10 rounded-2xl p-4 flex flex-col items-center justify-center relative shadow-lg group">
                <span class="text-[9px] text-gray-400 uppercase tracking-widest font-bold z-10">Time</span>
                <div id="timerDisplay" class="text-2xl font-mono text-saffron font-bold z-10 mt-1">00:00</div>
                <button onclick="toggleTimer()" class="absolute inset-0 z-20 flex items-center justify-center bg-black/60 opacity-0 group-hover:opacity-100 transition duration-300">
                    <i id="timerIcon" class="fas fa-pause text-white"></i>
                </button>
                <div id="timerDot" class="absolute top-3 right-3 w-1.5 h-1.5 rounded-full bg-green-500 hidden animate-pulse"></div>
            </div>
        </div>

        <!-- BEAD COUNTER -->
        <div class="relative w-[300px] h-[300px] flex items-center justify-center mb-4">
            <svg class="absolute inset-0 w-full h-full pointer-events-none drop-shadow-[0_0_15px_rgba(255,153,51,0.2)]">
                <circle class="text-white/5" stroke-width="12" stroke="currentColor" fill="transparent" r="135" cx="150" cy="150" />
                <circle id="progressRing" class="ring-progress text-saffron" stroke-width="12" stroke-dasharray="848" stroke-dashoffset="848" stroke-linecap="round" stroke="currentColor" fill="transparent" r="135" cx="150" cy="150" />
            </svg>

            <!-- TAP BUTTON -->
            <button id="tapBtn" onmousedown="handleTap()" ontouchstart="handleTap(event)" 
                class="relative w-[230px] h-[230px] rounded-full border-[6px] border-[#222] shadow-2xl flex flex-col items-center justify-center z-20 transition-all duration-75 overflow-hidden bg-cover bg-center group"
                style="background-image: url('https://i.pinimg.com/736x/21/df/b4/21dfb4c7324867990022830f78137351.jpg');">
                
                <div class="absolute inset-0 bg-black/60 group-active:bg-black/50 transition duration-200"></div>
                <span id="beadCount" class="relative z-10 text-[5rem] font-bold leading-none text-white drop-shadow-lg select-none">0</span>
                <span class="relative z-10 text-[10px] text-gray-300 tracking-[5px] font-bold mt-1 select-none">BEADS</span>
            </button>
        </div>

        <!-- Mantra -->
        <div class="text-center space-y-1 opacity-70 mt-4">
            <h3 class="text-saffron font-bold text-sm font-serif">Hare Krishna Hare Krishna</h3>
            <p class="text-[10px] text-gray-400 font-sans tracking-wide">Krishna Krishna Hare Hare • Hare Rama Hare Rama • Rama Rama Hare Hare</p>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="bg-[#080808] border-t border-white/5 p-3 pb-6 z-20">
        <div class="flex justify-around items-center max-w-sm mx-auto">
            <button onclick="toggleAudio()" id="audioBtn" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-music text-lg text-gray-500 group-hover:text-saffron transition"></i>
                <span class="text-[9px] text-gray-500">Audio</span>
            </button>
            <button onclick="resetBeads()" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-undo text-lg text-gray-500 group-hover:text-red-500 transition"></i>
                <span class="text-[9px] text-gray-500">Reset</span>
            </button>
            <button onclick="shareProgress()" class="flex flex-col items-center gap-1 group">
                <i class="fas fa-share-alt text-lg text-gray-500 group-hover:text-blue-500 transition"></i>
                <span class="text-[9px] text-gray-500">Share</span>
            </button>
        </div>
    </footer>

    <!-- SETTINGS MODAL -->
    <div id="settingsModal" class="hidden fixed inset-0 z-50 bg-black/90 backdrop-blur-sm flex items-center justify-center p-4 animate-fade-in">
        <div class="bg-[#121212] w-full max-w-sm rounded-2xl border border-white/10 p-6 shadow-2xl relative">
            <button onclick="closeModal('settingsModal')" class="absolute top-4 right-4 text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-saffron font-serif text-xl mb-6">Settings</h2>

            <!-- Custom Target -->
            <div class="mb-6">
                <label class="text-[10px] text-gray-400 font-bold uppercase tracking-wider mb-2 block">Set Daily Goal</label>
                <div class="grid grid-cols-3 gap-2 mb-3">
                    <button onclick="setTargetInput(16)" class="py-2 rounded-lg bg-white/5 border border-white/10 text-xs font-bold hover:border-saffron focus:bg-saffron focus:text-black">16</button>
                    <button onclick="setTargetInput(32)" class="py-2 rounded-lg bg-white/5 border border-white/10 text-xs font-bold hover:border-saffron focus:bg-saffron focus:text-black">32</button>
                    <button onclick="setTargetInput(64)" class="py-2 rounded-lg bg-white/5 border border-white/10 text-xs font-bold hover:border-saffron focus:bg-saffron focus:text-black">64</button>
                </div>
                <div class="relative">
                    <input type="number" id="customTargetInput" placeholder="Custom Target" class="w-full bg-black border border-white/20 rounded-lg py-3 px-4 text-sm text-white focus:border-saffron">
                    <span class="absolute right-4 top-3 text-xs text-gray-500">Rounds</span>
                </div>
            </div>

            <!-- Toggles -->
            <div class="space-y-4 border-t border-white/10 pt-5">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-300">Sound Effects</span>
                    <input type="checkbox" id="soundToggle" class="w-5 h-5 accent-saffron">
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-300">Vibration</span>
                    <input type="checkbox" id="vibToggle" class="w-5 h-5 accent-saffron">
                </div>
                <div class="flex justify-between items-center">
                    <div class="flex flex-col">
                        <span class="text-sm text-gray-300">Smart Notifications</span>
                        <span class="text-[9px] text-gray-500">Reminds remaining rounds</span>
                    </div>
                    <input type="checkbox" id="notifyToggle" onchange="requestNotifyPermission()" class="w-5 h-5 accent-saffron">
                </div>
                <button onclick="testNotification()" class="text-xs text-saffron underline w-full text-right mt-1 hover:text-white transition">Test Notification Now</button>
            </div>

            <button onclick="saveSettings()" class="w-full mt-6 bg-saffron text-black font-bold py-3.5 rounded-xl hover:bg-orange-500 transition">Save Changes</button>
        </div>
    </div>

    <!-- HISTORY MODAL (ADVANCED) -->
    <div id="historyModal" class="hidden fixed inset-0 z-50 bg-black/95 flex items-end sm:items-center justify-center animate-fade-in">
        <div class="bg-[#121212] w-full sm:w-[450px] h-[90vh] sm:h-[700px] sm:rounded-2xl rounded-t-2xl border border-white/10 flex flex-col shadow-2xl">
            
            <!-- Header -->
            <div class="p-4 border-b border-white/10 flex justify-between items-center bg-[#181818] rounded-t-2xl">
                <h2 class="text-saffron font-serif text-lg">Japa History</h2>
                <button onclick="closeModal('historyModal')" class="text-gray-400 text-xl hover:text-white">&times;</button>
            </div>

            <!-- Lifetime Stats Summary -->
            <div class="grid grid-cols-2 gap-4 p-4 border-b border-white/5 bg-[#141414]">
                <div class="text-center">
                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Lifetime Rounds</div>
                    <div id="histTotalRounds" class="text-2xl font-bold text-white mt-1">0</div>
                    <div class="text-[9px] text-saffron mt-0.5" id="histTotalBeads">0 Mantras</div>
                </div>
                <div class="text-center border-l border-white/10">
                    <div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">Best Day</div>
                    <div id="histBestDay" class="text-2xl font-bold text-white mt-1">0</div>
                    <div class="text-[9px] text-gray-400 mt-0.5">Rounds in one day</div>
                </div>
            </div>
            
            <!-- Date Wise List -->
            <div class="p-3 bg-[#0a0a0a] text-xs text-gray-500 font-bold border-b border-white/5">DATE-WISE RECORD</div>
            <div id="historyList" class="flex-1 overflow-y-auto p-4 space-y-3 hide-scroll">
                <!-- Javascript will inject Cards here -->
            </div>
        </div>
    </div>

    <!-- CELEBRATION MODAL -->
    <div id="celebrationModal" class="hidden fixed inset-0 z-[60] bg-black/95 flex items-center justify-center p-6 animate-fade-in">
        <div class="bg-[#1a1a1a] border-2 border-saffron w-full max-w-xs rounded-2xl p-8 text-center relative shadow-[0_0_50px_rgba(255,153,51,0.3)]">
            <i class="fas fa-check-circle text-5xl text-saffron mb-4 animate-bounce"></i>
            <h2 class="text-2xl text-white font-serif font-bold mb-1">Round Complete!</h2>
            <p class="text-xs text-gray-400 mb-6">"Chant and be happy"</p>

            <div class="bg-black/50 rounded-xl p-4 mb-6 border border-white/5">
                <div class="flex justify-between text-xs text-gray-400 mb-1"><span>Round #</span><span id="celRoundNum" class="text-saffron font-bold">1</span></div>
                <div class="flex justify-between text-xs text-gray-400"><span>Time</span><span id="celTime" class="text-white font-mono">00:00</span></div>
            </div>

            <button onclick="startNextRound()" class="w-full bg-saffron text-black font-bold py-3 rounded-xl hover:scale-105 transition active:bg-orange-600 shadow-lg">
                Start Next Round
            </button>
        </div>
    </div>

    <!-- AUDIO -->
    <audio id="clickSound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    <audio id="bgAudio" loop src="https://archive.org/download/SrilaPrabhupadaJapa/SrilaPrabhupadaJapa_64kb.mp3"></audio>

    <script>
        // --- CONSTANTS ---
        const MAX_BEADS = 108;
        const CIRCUMFERENCE = 848; 
        
        let state = {
            beads: 0,
            roundsToday: 0,
            target: 16,
            timer: { running: false, elapsed: 0 },
            history: {}, 
            settings: { sound: true, vib: true, notify: false },
            streak: 0,
            lastActivity: Date.now()
        };

        let timerInterval = null;
        let notifyInterval = null;

        // --- INIT ---
        window.onload = () => {
            loadData();
            updateUI();
            notifyInterval = setInterval(checkNotifications, 600000); // Check every 10 mins
            if(state.timer.running) toggleTimer(true);
        };

        // --- CHANTING LOGIC ---
        function handleTap(e) {
            if(e) e.preventDefault();
            
            state.beads++;
            state.lastActivity = Date.now();

            if(state.beads === 1 && !state.timer.running) toggleTimer(true);

            // Visuals
            const btn = document.getElementById('tapBtn');
            btn.classList.add('tap-active');
            setTimeout(() => btn.classList.remove('tap-active'), 100);

            // Audio/Vib
            if(state.settings.vib && navigator.vibrate) navigator.vibrate(40);
            if(state.settings.sound) {
                const aud = document.getElementById('clickSound');
                aud.currentTime = 0;
                aud.play().catch(()=>{});
            }

            if(state.beads >= MAX_BEADS) {
                completeRound();
            } else {
                updateUI();
                saveData();
            }
        }

        function completeRound() {
            toggleTimer(false);
            state.roundsToday++;
            
            // History
            const today = new Date().toISOString().split('T')[0];
            if(!state.history[today]) state.history[today] = [];
            state.history[today].push({
                time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                duration: formatTime(state.timer.elapsed),
                roundNum: state.roundsToday
            });

            // Update UI Modal
            document.getElementById('celRoundNum').innerText = state.roundsToday;
            document.getElementById('celTime').innerText = formatTime(state.timer.elapsed);
            document.getElementById('celebrationModal').classList.remove('hidden');
            
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#FF9933', '#ffffff'] });
            
            saveData();
            updateUI();
        }

        function startNextRound() {
            document.getElementById('celebrationModal').classList.add('hidden');
            state.beads = 0;
            state.timer.elapsed = 0;
            if(state.timer.running) toggleTimer(false);
            updateUI();
            saveData();
            document.getElementById('timerDisplay').innerText = "00:00";
        }

        // --- ADVANCED HISTORY RENDER (The Update) ---
        function renderHistory() {
            const list = document.getElementById('historyList');
            list.innerHTML = "";
            const dates = Object.keys(state.history).sort((a,b) => new Date(b) - new Date(a)); // Sort descending
            const todayStr = new Date().toISOString().split('T')[0];
            
            // Calculate Lifetime Stats
            let totalLifetimeRounds = 0;
            let bestDay = 0;

            if(dates.length === 0) {
                list.innerHTML = "<div class='text-center text-gray-500 mt-10 text-xs'>No history yet. Start chanting today!</div>";
                document.getElementById('histTotalRounds').innerText = "0";
                document.getElementById('histTotalBeads').innerText = "0 Mantras";
                document.getElementById('histBestDay').innerText = "0";
                return;
            }

            // Loop Dates
            dates.forEach(date => {
                const rounds = state.history[date];
                const count = rounds.length;
                
                // Stats Logic
                totalLifetimeRounds += count;
                if(count > bestDay) bestDay = count;

                // Create Date Card
                const card = document.createElement('div');
                card.className = "history-card bg-[#1a1a1a] rounded-xl overflow-hidden border border-white/5 mb-3 transition-all";
                
                // Human Friendly Date
                const dateObj = new Date(date);
                const isToday = date === todayStr;
                // Check if Yesterday
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
                const isYesterday = date === yesterday.toISOString().split('T')[0];
                
                let displayDate = dateObj.toLocaleDateString('en-US', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
                if(isToday) displayDate = "Today";
                if(isYesterday) displayDate = "Yesterday";

                // Header
                const header = document.createElement('div');
                header.className = "flex justify-between items-center p-4 cursor-pointer hover:bg-white/5 transition";
                header.onclick = () => {
                    // Close others
                    document.querySelectorAll('.history-card').forEach(el => { if(el!==card) el.classList.remove('active'); });
                    card.classList.toggle('active');
                };

                header.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="bg-saffron/20 text-saffron w-9 h-9 rounded-full flex items-center justify-center font-bold text-sm border border-saffron/30 shadow-inner">${count}</div>
                        <div>
                            <div class="font-bold text-white text-sm flex items-center gap-2">
                                ${displayDate} 
                                ${isToday ? '<span class="text-[9px] bg-green-500/20 text-green-500 px-1.5 rounded">ACTIVE</span>' : ''}
                            </div>
                            <div class="text-[10px] text-gray-500">${count} Rounds Completed</div>
                        </div>
                    </div>
                    <i class="fas fa-chevron-down text-gray-500 chevron text-sm"></i>
                `;

                // Body (Details)
                const body = document.createElement('div');
                body.className = "history-details bg-[#111]";
                
                let rows = `<div class="p-3 space-y-2 border-t border-white/5">`;
                rounds.forEach((r, idx) => {
                    rows += `
                        <div class="flex justify-between items-center text-xs bg-white/5 p-2.5 rounded border border-white/5 hover:border-saffron/30 transition">
                            <div class="flex items-center gap-2">
                                <span class="text-saffron font-bold text-[10px] bg-saffron/10 px-1.5 py-0.5 rounded">#${r.roundNum}</span>
                                <span class="text-gray-400">at ${r.time}</span>
                            </div>
                            <span class="font-mono text-white">${r.duration}</span>
                        </div>
                    `;
                });
                rows += `</div>`;
                body.innerHTML = rows;

                card.appendChild(header);
                card.appendChild(body);
                list.appendChild(card);
            });

            // Update Summary Stats
            document.getElementById('histTotalRounds').innerText = totalLifetimeRounds;
            document.getElementById('histTotalBeads').innerText = (totalLifetimeRounds * 108).toLocaleString() + " Mantras";
            document.getElementById('histBestDay').innerText = bestDay;
        }

        // --- NOTIFICATION LOGIC ---
        function requestNotifyPermission() {
            if (!("Notification" in window)) return;
            Notification.requestPermission().then(permission => {
                state.settings.notify = (permission === "granted");
                document.getElementById('notifyToggle').checked = state.settings.notify;
            });
        }

        function checkNotifications() {
            if(!state.settings.notify || Notification.permission !== "granted") return;
            const inactiveTime = Date.now() - state.lastActivity;
            
            if (inactiveTime > 7200000 && state.roundsToday < state.target) {
                sendNotification();
                state.lastActivity = Date.now(); 
            }
        }

        function sendNotification() {
            const remaining = state.target - state.roundsToday;
            const msg = remaining > 0 
                ? `Hare Krishna! You have completed ${state.roundsToday} rounds. ${remaining} more to go for your target of ${state.target}.`
                : `Hare Krishna! Target reached (${state.target}). Keep chanting!`;

            new Notification("ISKCON Hadapsar", {
                body: msg,
                icon: "https://cdn-icons-png.flaticon.com/512/3663/3663335.png",
                vibrate: [200, 100, 200]
            });
        }

        function testNotification() {
            if(Notification.permission === "granted") sendNotification();
            else alert("Permission not granted.");
        }

        // --- SETTINGS & UTILS ---
        function setTargetInput(val) { document.getElementById('customTargetInput').value = val; }
        
        function saveSettings() {
            const val = document.getElementById('customTargetInput').value;
            if(val > 0) state.target = parseInt(val);
            state.settings.sound = document.getElementById('soundToggle').checked;
            state.settings.vib = document.getElementById('vibToggle').checked;
            state.settings.notify = document.getElementById('notifyToggle').checked;
            saveData();
            updateUI();
            closeModal('settingsModal');
        }

        function updateUI() {
            document.getElementById('beadCount').innerText = state.beads;
            document.getElementById('roundsDisplay').innerText = state.roundsToday;
            document.getElementById('targetDisplay').innerText = `/ ${state.target}`;
            document.getElementById('streakDisplay').innerText = `${state.streak} Day Streak`;
            
            if(!state.timer.running && state.timer.elapsed === 0) {
                 document.getElementById('timerDisplay').innerText = "00:00";
            } else {
                 document.getElementById('timerDisplay').innerText = formatTime(state.timer.elapsed);
            }
            const offset = CIRCUMFERENCE - (state.beads / MAX_BEADS) * CIRCUMFERENCE;
            document.getElementById('progressRing').style.strokeDashoffset = offset;
        }

        function formatTime(s) {
            const m = Math.floor(s/60).toString().padStart(2,'0');
            const sec = (s%60).toString().padStart(2,'0');
            return `${m}:${sec}`;
        }

        function toggleTimer(force) {
            const run = force !== undefined ? force : !state.timer.running;
            if(run) {
                if(timerInterval) clearInterval(timerInterval);
                state.timer.running = true;
                timerInterval = setInterval(() => {
                    state.timer.elapsed++;
                    document.getElementById('timerDisplay').innerText = formatTime(state.timer.elapsed);
                }, 1000);
                document.getElementById('timerIcon').className = "fas fa-pause";
                document.getElementById('timerDot').classList.remove('hidden');
            } else {
                clearInterval(timerInterval);
                state.timer.running = false;
                document.getElementById('timerIcon').className = "fas fa-play";
                document.getElementById('timerDot').classList.add('hidden');
            }
            saveData();
        }

        function saveData() { localStorage.setItem('iskcon_v10', JSON.stringify(state)); }
        
        function loadData() {
            const raw = localStorage.getItem('iskcon_v10') || localStorage.getItem('iskcon_final');
            if(raw) {
                const data = JSON.parse(raw);
                state = { ...state, ...data };
                const today = new Date().toISOString().split('T')[0];
                if(!state.history[today]) {
                    state.roundsToday = 0; state.beads = 0; state.timer.elapsed = 0;
                } else {
                    state.roundsToday = state.history[today].length;
                }
            }
        }

        let isPlaying = false;
        function toggleAudio(){
            const aud = document.getElementById('bgAudio');
            const icon = document.getElementById('audioBtn').querySelector('i');
            if(isPlaying) { aud.pause(); icon.className="fas fa-music text-lg text-gray-500"; }
            else { aud.play(); icon.className="fas fa-pause text-lg text-saffron"; }
            isPlaying=!isPlaying;
        }

        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openModal(id) { 
            document.getElementById(id).classList.remove('hidden'); 
            if(id==='settingsModal') { 
                document.getElementById('customTargetInput').value = state.target; 
                document.getElementById('notifyToggle').checked = state.settings.notify; 
            } 
            if(id==='historyModal') renderHistory(); 
        }
        function openSettings() { openModal('settingsModal'); }
        function openHistory() { openModal('historyModal'); }
        function resetBeads() { if(confirm("Reset current bead count?")) { state.beads = 0; toggleTimer(false); updateUI(); saveData(); } }
        function shareProgress() { navigator.share ? navigator.share({text: `Hare Krishna! Completed ${state.roundsToday} rounds.`}) : alert("Copied!"); }

    </script>
</body>
</html>
